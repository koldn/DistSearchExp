<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>DistSearch</title>

    <meta name="description" content="SMP Distributed search experience">
    <meta name="author" content="Dmitriy Kolmogortsev">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/sky.css" id="theme">

    <link rel="stylesheet" href="css/hljs/idea.css" id="highlight-theme">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->

    <style>
        .reveal .slide-number {
            font-size: 22pt;
            color: black;
        }
        
        .reveal pre {
            background: none;
            border: none;
            box-shadow: none;
        }
        
        .reveal pre code {
            color: black;
            background: none;
            box-shadow: none;
            max-height: none;
        }
        /* .reveal section img {
            border: none;
            box-shadow: none;
        }*/
        
        .reveal pre code {
            overflow: hidden;
        }
        
        .reveal .footer {
            font-size: 22pt;
            position: absolute;
            left: 35%;
            bottom: 0.5em;
        }
        
        #corp-name {
            color: orangered;
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
        }
        
        .red-text {
            color: red;
        }
    </style>
</head>

<body>

    <div class="reveal">
        <div class="footer">
            <span id="corp-name"><b>NAUMEN</b></span>
            <span id="speaker-name">Колмогорцев Дмитрий</span>
        </div>
        <!-- Any section element inside of this container is displayed as a slide -->
        <div class="slides">
            <section>
                <h2>Распределенный поиск в SMP</h2>
                <p>
                    <small>
                        Колмогорцев Дмитрий / <a href="mailto:dkolmogortsev@naumen.ru">dkolmogortsev@naumen.ru</a>
                        <br/>
                        <br/>
                        </small>
                </p>
            </section>
            <section>
                <h2>Before we start</h2>
                <ul>
                    <li>Опыт SD4</li>
                    <li>В основном моя боль</li>
                </ul>
            </section>
            <section>
                <h2> Lucene - наше всё</h2>
            </section>
            <section>
                <h5>Как развивалось</h5>
                <p class="fragment fade-down">
                    Standalone приложение: индексы лежат на файловой системе
                </p>
                <p class="fragment fade-down">
                    Счастье, доброта, котятки
                </p>
                <p class="fragment fade-down">
                    Случился кластер
                </p>
                <p class="fragment fade-down">
                    JDBC Directory - весь индекс лежит в БД
                </p>
            </section>
            <section data-background="img/unicorn.gif" data-background-transition="zoom">

            </section>
            <section data-background="img/fire-nation.gif" data-background-transition="zoom">

            </section>
            <section>
                <h2>Infinispan Directory</h2>
                <p>InMemory индексы</p>
            </section>
            <section>
                <h3>Строится на 3-х кешах:</h3>
                <ol>
                    <li class="fragment">Metadata Cache - Описание данных (Replicated) <span class="fragment" style="color:green;">Backed by DB</span></li>
                    <li class="fragment">Chunks Cache - Данные (Distributed) <span class="fragment red-text">Replicated</span> <span class="fragment" style="color:green;">Backed by DB</span> </li>
                    <li class="fragment">Locks Cache - Распределенные блокировки (Distributed)<span class="fragment red-text">Not used</span></li>
                </ol>
            </section>
            <section data-background="img/indexation.png" data-background-size="55%" data-background-transition="zoom"> 

            </section>
            <section data-background="img/loading.png" data-background-size="55%" data-background-transition="zoom"> 
                
            </section>
            <section data-transition="zoom">
                <h2>Profit!</h2>
            </section>
            <section>
                <h2>Первые проблемы</h2>
                <p>
                    ${Представьте, что здесь изображена потеря связи до БД}
                </p>
            </section>
            <section>
                <code data-trim class="java red-text">FileNotFoundException: error loading metadata for ${filename}</code><br><br>
                <p class="fragment">Каждую секунду! Каждую секунду, Карл</p>
                <p class="fragment">Индексация не работает!</p>
                <p class="fragment">Поиск не работает!</p>
                <p class="fragment">Все пропало!</p>

            </section>
            <section>
                <h2>Будем резервировать индекс!</h2>
                <ul>
                    <li class="fragment">Файловая система: Сохранение всех файлов индекса в архиве рядом с рабочими файлами</li>
                    <li class="fragment">Infinispan: Копирование таблиц с индексом <b class="fragment red-text">SPOILER: просто так оно не работает</b></li>
                </ul>
            </section>
            <section>
                <h2>10.03.2017</h2>
                <p class="fragment">
                    Жизнь разделилась на До и После
                </p>
            </section>
            <section>
                <p>Вопросы на данный момент</p>
                <ul>
                    <li class="fragment">Запись в БД происходит в рамках одного соединения?</li>
                    <li class="fragment">Почему при любой проблеме индекс ломается?</li>
                    <li class="fragment">Почему восстановление таблиц индекса не приводит к успеху?</li>
                </ul>
            </section>
            <section data-background="img/pepe.png" data-background-transition="zoom" data-background-size="50%"> 
                
            </section>
            <section>
                <p>Происходит ли запись в БД в рамках одного соединения? <span class="fragment red-text"> - нет</span></p>
                <ul>
                    <li class="fragment">Каждый кеш - своя настройка синхронизации с БД</li>
                    <li class="fragment">На каждое изменение - новое соединие</li>
                    <li class="fragment">Не атомарно - проблема</li>
                </ul>
            </section>
            <section>
                <h4>Пишем атомарно</h4>
                <ul>
                    <li class="fragment">Metadata cache + Chunks cache = Index Cache</li>
                    <li class="fragment">Собственный перехватчик комманд, который сливает все изменения в рамках одной транзакции</li>
                    <li class="fragment">Custom LRU eviction for Index Cache (наткнулись на баг в Java)</li>
                </ul>
            </section>
            <section>
                <h3>Почему все сразу ломается?!</h3>
                <div class="fragment">
                    <p>После предыдущих манипуляций получилось как-то так:</p>
                    <pre>
                        <code data-trim data-noescape class="java">
                            {
                                try(IndexWriter iw = getWriter()){
                                    ...
                                    txAction(() -> {
                                        iw.commit();
                                    });
                                }
                                ...
                            }
                        </code>
                    </pre>
                </div>
            </section>
            <section>
                <h3>Разберем что происходит</h3>
                <div>
                    <pre>
                        <code class="java" data-noescape>
                    txAction(() -> {
                        iw.commit();
                    });
                        </code>
                    </pre>
                    <div class="fragment">
                        Все коммиты кроме последнего будут удалены (По умолчанию)
                    </div>
                </div>
            </section>
            <section>
                <h3>
                    Что далее:
                </h3>
                <pre>
                        <code class="java" data-noescape>
                    InfinispanTxSync
                    {
                        afterCompletion(int status){
                            ...
                            cache.prepare()
                            ...
                            cache.commit()
                        }
                    }
                        </code>
                    </pre>
                <div>
                    Что же может пойти не так? <b class="fragment red-text"> ВСЁ</b><br>
                    <span class="fragment">и мы об этом никогда не узнаем =(</span>
                </div>
            </section>
            <section>
                <h2>Сюрприз в TransactionManager</h2>
                <pre>
                    <code data-trim class="java">
                            try
                            {
                                _theSynch.afterCompletion(s);
                
                                return true;
                            }
                            catch (Exception e)
                            {
                                jtaLogger.i18NLogger.warn_resources_arjunacore...
                
                                return false; // should not cause any affect!
                            }

                    </code>
                </pre>
            </section>
            <section>
                <h2>Что делать, товарищи?</h2>
                <ol>
                    <li class="fragment">Учиться хранить не только последний коммит</li>
                    <li class="fragment">Учиться следить за транзакциями в кеше</li>
                </ol>
            </section>
            <section>
                <h3>
                    Научились
                </h3>
                <pre>
                    <code class="java" data-trim>
                        {
                            indexCachemonitor.start();
                            runInTx(() -> {
                                try(IndexWriter iw = getWriter(${n-1 commit policy})){
                                    ...
                                    iw.commt();
                                }
                            }
                            if(indexCachemonitor.isTransactionFailed()){
                                rollBackComponent.rollBack()
                            }
                        }
                    </code>
                </pre>
            </section>
            <section>
                <h3>indexCachemonitor</h3>
                <pre>
                    <code style="font-size: 80%"class="java" data-trim>
                        public class IndexCacheMonitor
                        {
                            @Listener
                            private static final class IndexCacheListener
                            {                       
                                @TransactionCompleted
                                public void txComplete(
                                    TransactionCompletedEvent&lt?, ?&gt transactionEvent
                                ) 
                                { ... }
                            }
                    
                            public boolean isTransactionFailed() { ... }
                            
                            public void start() { indexCache.addListener(CACHE_LISTENER); }
                            public void stop() { indexCache.removeListener(CACHE_LISTENER); }
                        }
                    </code>
                </pre>
            </section>
            <section>
                <h3>Now what?</h3>
                <div class="fragment">
                    <p>Проблемы еще есть, и они постепенно решаются</p>
                    <img src="img/problems.png" height="400">
                </div>
            </section>
            <section>
                <h3>One more thing</h3>
                <p class="fragment">
                    При попытке таки использовать LocksCache я получил...
                </p>
            </section>
            <section>
                <code class="red-text">AbstractMethodError</code>
                <br>
                <img src="img/wtf.gif" />
            </section>
            <section>
                <h3>Why?!</h3>
                Lucene 4.7 и Infinispan Directory 6.0 <br> в одном месте очень не совместимы
            </section>

            <section>
                <h3>KK THX BYE</h3>
            </section>
        </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
        // Full list of configuration options available at:
        // https://github.com/hakimel/reveal.js#configuration
        Reveal.initialize({
            controls: false,
            progress: true,
            history: true,
            center: true,
            slideNumber: true,

            transition: 'slide', // none/fade/slide/convex/concave/zoom

            // Optional reveal.js plugins
            dependencies: [{
                src: 'lib/js/classList.js',
                condition: function() {
                    return !document.body.classList;
                }
            }, {
                src: 'plugin/markdown/marked.js',
                condition: function() {
                    return !!document.querySelector('[data-markdown]');
                }
            }, {
                src: 'plugin/markdown/markdown.js',
                condition: function() {
                    return !!document.querySelector('[data-markdown]');
                }
            }, {
                src: 'plugin/highlight/highlight.js',
                async: true,
                condition: function() {
                    return !!document.querySelector('pre code');
                },
                callback: function() {
                    hljs.initHighlightingOnLoad();
                }
            }, {
                src: 'plugin/zoom-js/zoom.js',
                async: true
            }, {
                src: 'plugin/notes/notes.js',
                async: true
            }]
        });
    </script>

</body>

</html>